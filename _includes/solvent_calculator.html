<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>溶液计算器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css">
    <style>
        /* Chirpy-compatible styles */
        :root {
            --chirpy-body-bg: #fafafa;
            --chirpy-card-bg: #fff;
            --chirpy-text-color: #212529;
            --chirpy-link-color: #2a408e;
            --chirpy-border-color: #e9ecef;
            --chirpy-heading-color: #2a2a2a;
            --chirpy-btn-primary: #2a408e;
            --chirpy-btn-text: #fff;
            --chirpy-success-bg: #d4edda;
            --chirpy-success-text: #155724;
            --chirpy-error-bg: #f8d7da;
            --chirpy-error-text: #721c24;
            --chirpy-shadow: rgba(0, 0, 0, 0.05);
            --chirpy-border-radius: 0.5rem;
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --chirpy-body-bg: #1e1e1e;
                --chirpy-card-bg: #2a2a2a;
                --chirpy-text-color: #dee2e6;
                --chirpy-link-color: #8ab4f8;
                --chirpy-border-color: #4a4a4a;
                --chirpy-heading-color: #e6e6e6;
                --chirpy-btn-primary: #8ab4f8;
                --chirpy-success-bg: #285a36;
                --chirpy-success-text: #d1e7dd;
                --chirpy-error-bg: #842029;
                --chirpy-error-text: #f8d7da;
                --chirpy-shadow: rgba(0, 0, 0, 0.2);
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            padding: 20px;
            max-width: 100%;
            margin: 0 auto;
            background-color: var(--chirpy-body-bg);
            color: var(--chirpy-text-color);
            transition: all 0.3s ease;
        }

        .container {
            background-color: var(--chirpy-card-bg);
            border-radius: var(--chirpy-border-radius);
            padding: 1.5rem;
            box-shadow: 0 4px 10px var(--chirpy-shadow);
            border: 1px solid var(--chirpy-border-color);
            transition: all 0.3s ease;
        }

        h2 {
            color: var(--chirpy-heading-color);
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        .form-control, .form-select {
            background-color: var(--chirpy-body-bg);
            color: var(--chirpy-text-color);
            border: 1px solid var(--chirpy-border-color);
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--chirpy-link-color);
            box-shadow: 0 0 0 0.25rem rgba(42, 64, 142, 0.25);
        }

        .col-form-label {
            color: var(--chirpy-heading-color);
            font-weight: 500;
        }

        .btn-primary {
            background-color: var(--chirpy-btn-primary);
            border-color: var(--chirpy-btn-primary);
            color: var(--chirpy-btn-text);
        }

        .btn-primary:hover {
            background-color: var(--chirpy-link-color);
            border-color: var(--chirpy-link-color);
            filter: brightness(110%);
        }

        .btn-outline-secondary {
            color: var(--chirpy-text-color);
            border-color: var(--chirpy-border-color);
        }

        .btn-outline-secondary:hover {
            background-color: var(--chirpy-border-color);
            color: var(--chirpy-heading-color);
        }

        #structureImage {
            max-width: 300px;
            margin: 15px auto;
            border: 1px solid var(--chirpy-border-color);
            border-radius: var(--chirpy-border-radius);
            padding: 10px;
            background-color: var(--chirpy-card-bg);
        }

        .modal-content {
            background-color: var(--chirpy-card-bg);
            color: var(--chirpy-text-color);
            border-radius: var(--chirpy-border-radius);
            border: 1px solid var(--chirpy-border-color);
        }

        .modal-header, .modal-footer {
            border-color: var(--chirpy-border-color);
        }

        #resultLabel {
            margin-top: 15px;
            padding: 10px;
            border-radius: var(--chirpy-border-radius);
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .success {
            background-color: var(--chirpy-success-bg);
            color: var(--chirpy-success-text);
        }

        .error {
            background-color: var(--chirpy-error-bg);
            color: var(--chirpy-error-text);
        }

        /* Fix SVG visibility in dark mode */
        #structureImage svg {
            background-color: white;
            border-radius: var(--chirpy-border-radius);
        }

        /* Media queries for better responsive behavior */
        @media (max-width: 768px) {
            .col-form-label {
                text-align: left;
                margin-bottom: 0.5rem;
            }
            .container {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2 class="text-center mb-4">溶液计算器</h2>
        
        <div class="form-group row mb-3">
            <label for="molecularWeight" class="col-sm-3 col-form-label">分子量:</label>
            <div class="col-sm-9">
                <div class="input-group">
                    <input type="text" class="form-control" id="molecularWeight">
                    <button class="btn btn-outline-secondary" type="button" id="openSmilesButton">输入SMILES或CAS号</button>
                </div>
            </div>
        </div>
        
        <div class="form-group row mb-3">
            <label for="concentration" class="col-sm-3 col-form-label">目标浓度:</label>
            <div class="col-sm-9">
                <div class="input-group">
                    <input type="text" class="form-control" id="concentration" value="2">
                    <select class="form-select" id="concentrationUnit" style="max-width: 120px;">
                        <option value="mmol/L">mmol/L</option>
                        <option value="mol/L">mol/L</option>
                        <option value="g/L">g/L</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="form-group row mb-3">
            <label for="mass" class="col-sm-3 col-form-label">称量的质量:</label>
            <div class="col-sm-9">
                <div class="input-group">
                    <input type="text" class="form-control" id="mass">
                    <select class="form-select" id="massUnit" style="max-width: 120px;">
                        <option value="g">g</option>
                        <option value="mg">mg</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="form-group row mb-3">
            <label for="volume" class="col-sm-3 col-form-label">需要的体积:</label>
            <div class="col-sm-9">
                <div class="input-group">
                    <input type="text" class="form-control" id="volume">
                    <select class="form-select" id="volumeUnit" style="max-width: 120px;">
                        <option value="mL">mL</option>
                        <option value="L">L</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-4 mb-3">
            <button class="btn btn-primary px-4 py-2" id="calculateButton">计算</button>
        </div>
        
        <div id="resultLabel" class="text-center mt-3" style="display: none;"></div>
    </div>
    
    <!-- SMILES Input Modal -->
    <div class="modal fade" id="smilesModal" tabindex="-1" aria-labelledby="smilesModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="smilesModalLabel">输入SMILES或CAS号</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="smilesInput" class="form-label">请输入 SMILES 或 CAS号:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="smilesInput">
                            <button class="btn btn-outline-secondary" type="button" id="processInputButton">处理输入</button>
                        </div>
                    </div>
                    <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>
                    <div id="structureContainer" class="text-center" style="display: none;">
                        <div id="structureImage"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirmSelectionButton" style="display: none;">确认</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load essential libraries first -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/openchemlib/dist/openchemlib-full.js"></script>

    <script>
        // 全局变量
        let currentSmiles = null;
        let smilesModal = null;
        
        // 修改为使用 window.onload 而不是 DOMContentLoaded
        // 并添加延迟确保所有资源已加载
        window.onload = function() {
            // 添加1秒延迟确保所有外部资源加载完成
            setTimeout(function() {
                initializeCalculator();
            }, 1000);
        };
        
        // 初始化函数，单独抽出以便重试
        function initializeCalculator() {
            console.log("正在初始化溶液计算器...");
            
            try {
                // 确保必要的库已加载
                if (typeof bootstrap === 'undefined') {
                    console.error("Bootstrap未加载，尝试重新加载...");
                    loadScript("https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js", initializeCalculator);
                    return;
                }
                
                if (typeof OCL === 'undefined') {
                    console.error("OpenChemLib未加载，尝试重新加载...");
                    loadScript("https://unpkg.com/openchemlib/dist/openchemlib-full.js", initializeCalculator);
                    return;
                }
                
                // 初始化模态框
                const modalElement = document.getElementById('smilesModal');
                if (!modalElement) {
                    console.error("找不到模态框元素!");
                    return;
                }
                
                smilesModal = new bootstrap.Modal(modalElement);
                
                // 获取按钮元素并检查是否存在
                const openSmilesButton = document.getElementById('openSmilesButton');
                const processInputButton = document.getElementById('processInputButton');
                const confirmSelectionButton = document.getElementById('confirmSelectionButton');
                const calculateButton = document.getElementById('calculateButton');
                
                // 检查所有按钮是否存在
                if (!openSmilesButton || !processInputButton || !confirmSelectionButton || !calculateButton) {
                    console.error("找不到一个或多个按钮元素!");
                    const missing = [];
                    if (!openSmilesButton) missing.push('openSmilesButton');
                    if (!processInputButton) missing.push('processInputButton');
                    if (!confirmSelectionButton) missing.push('confirmSelectionButton');
                    if (!calculateButton) missing.push('calculateButton');
                    console.error("缺少的按钮: " + missing.join(', '));
                    return;
                }
                
                // 使用更可靠的事件绑定方法
                openSmilesButton.onclick = function() {
                    const smilesInput = document.getElementById('smilesInput');
                    if (smilesInput) smilesInput.value = '';
                    
                    const errorMessage = document.getElementById('errorMessage');
                    if (errorMessage) errorMessage.style.display = 'none';
                    
                    const structureContainer = document.getElementById('structureContainer');
                    if (structureContainer) structureContainer.style.display = 'none';
                    
                    if (confirmSelectionButton) confirmSelectionButton.style.display = 'none';
                    
                    if (smilesModal) smilesModal.show();
                };
                
                processInputButton.onclick = processInput;
                confirmSelectionButton.onclick = confirmSelection;
                calculateButton.onclick = calculate;
                
                // 监听分子量输入框失去焦点事件
                const molecularWeight = document.getElementById('molecularWeight');
                if (molecularWeight) {
                    molecularWeight.onblur = onMolecularWeightChange;
                }
                
                // 监听输入框键盘事件
                const smilesInput = document.getElementById('smilesInput');
                if (smilesInput) {
                    smilesInput.onkeypress = function(e) {
                        if (e.key === 'Enter') {
                            processInput();
                        }
                    };
                }
                
                console.log("溶液计算器初始化完成");
            } catch (error) {
                console.error("初始化过程中出错:", error);
            }
        }
        
        // 辅助函数：动态加载脚本
        function loadScript(url, callback) {
            const script = document.createElement("script");
            script.type = "text/javascript";
            
            if (script.readyState) {  // 针对 IE
                script.onreadystatechange = function() {
                    if (script.readyState === "loaded" || script.readyState === "complete") {
                        script.onreadystatechange = null;
                        callback();
                    }
                };
            } else {  // 针对其他浏览器
                script.onload = function() {
                    callback();
                };
            }
            
            script.src = url;
            document.getElementsByTagName("head")[0].appendChild(script);
        }
        
        // 从CAS号获取SMILES
        async function getSmilesFromCas(casNumber) {
            try {
                const url = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${casNumber}/property/CanonicalSMILES/JSON`;
                const response = await fetch(url);
                
                if (response.ok) {
                    const data = await response.json();
                    try {
                        const smiles = data.PropertyTable.Properties[0].CanonicalSMILES;
                        return smiles;
                    } catch (error) {
                        showError("未找到该CAS号的SMILES");
                        return null;
                    }
                } else {
                    showError("无法从PubChem获取数据");
                    return null;
                }
            } catch (error) {
                showError("API请求失败: " + error.message);
                return null;
            }
        }
        
        // 计算分子量
        function calculateMolecularWeight(smiles) {
            try {
                // 确保OpenChemLib已加载
                if (typeof OCL === 'undefined') {
                    showError("OpenChemLib库未加载");
                    return null;
                }
                
                // 使用OpenChemLib计算分子量
                const molecule = OCL.Molecule.fromSmiles(smiles);
                
                // 获取MolecularFormula对象
                const formula = molecule.getMolecularFormula();
                
                // 直接访问relativeWeight属性
                const molecularWeight = formula.relativeWeight;
                return molecularWeight;
            } catch (error) {
                showError("计算分子量时出错: " + error.message);
                return null;
            }
        }
        
        // 处理SMILES或CAS号输入
        async function processInput() {
            const smilesInput = document.getElementById('smilesInput');
            if (!smilesInput) {
                console.error("找不到SMILES输入元素!");
                return;
            }
            
            const inputValue = smilesInput.value.trim();
            
            // 隐藏之前的错误信息
            const errorMessage = document.getElementById('errorMessage');
            if (errorMessage) {
                errorMessage.style.display = 'none';
            }
            
            if (inputValue === '') {
                showError("请输入SMILES或CAS号");
                return;
            }
            
            let smiles;
            
            // 判断是否为CAS号
            if (/-/.test(inputValue) && inputValue.split('-').every(part => /^\d+$/.test(part))) {
                // 如果像是CAS号，从PubChem获取SMILES
                smiles = await getSmilesFromCas(inputValue);
            } else {
                // 否则假设为SMILES
                smiles = inputValue;
            }
            
            if (smiles) {
                try {
                    // 使用OpenChemLib进行分子验证和显示
                    if (typeof OCL === 'undefined') {
                        showError("OpenChemLib库未加载");
                        return;
                    }
                    
                    const molecule = OCL.Molecule.fromSmiles(smiles);
                    
                    // 创建分子的SVG图像
                    const svgString = molecule.toSVG(300, 200);
                    
                    // 显示结构
                    const structureImage = document.getElementById('structureImage');
                    if (structureImage) {
                        structureImage.innerHTML = svgString;
                    }
                    
                    const structureContainer = document.getElementById('structureContainer');
                    if (structureContainer) {
                        structureContainer.style.display = 'block';
                    }
                    
                    const confirmSelectionButton = document.getElementById('confirmSelectionButton');
                    if (confirmSelectionButton) {
                        confirmSelectionButton.style.display = 'block';
                    }
                    
                    // 保存当前SMILES以便后续使用
                    currentSmiles = smiles;
                } catch (error) {
                    showError("无效的SMILES，请重新输入: " + error.message);
                }
            }
        }
        
        // 确认选择分子
        function confirmSelection() {
            if (currentSmiles) {
                const molecularWeight = calculateMolecularWeight(currentSmiles);
                if (molecularWeight) {
                    const molecularWeightInput = document.getElementById('molecularWeight');
                    if (molecularWeightInput) {
                        molecularWeightInput.value = molecularWeight.toFixed(2);
                    }
                    
                    if (smilesModal) {
                        smilesModal.hide();
                    }
                }
            }
        }
        
        // 分子量输入框变化处理
        async function onMolecularWeightChange() {
            const molecularWeightInput = document.getElementById('molecularWeight');
            if (!molecularWeightInput) return;
            
            const inputValue = molecularWeightInput.value.trim();
            
            if (inputValue === '') return;
            
            // 判断是否为数字
            if (!isNaN(inputValue)) return;
            
            // 判断是否为CAS号
            if (/-/.test(inputValue) && inputValue.split('-').every(part => /^\d+$/.test(part))) {
                const smiles = await getSmilesFromCas(inputValue);
                if (smiles) {
                    const molecularWeight = calculateMolecularWeight(smiles);
                    if (molecularWeight !== null) {
                        molecularWeightInput.value = molecularWeight.toFixed(2);
                    }
                }
            } else {
                // 尝试作为SMILES处理
                try {
                    const molecularWeight = calculateMolecularWeight(inputValue);
                    if (molecularWeight !== null) {
                        molecularWeightInput.value = molecularWeight.toFixed(2);
                    }
                } catch (error) {
                    // 如果既不是数字也不是有效的SMILES，不做处理
                }
            }
        }
        
        // 显示错误消息
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            } else {
                console.error("错误:", message);
            }
        }
        
        // 显示结果
        function showResult(message, isSuccess = true) {
            const resultElement = document.getElementById('resultLabel');
            if (resultElement) {
                resultElement.textContent = message;
                resultElement.className = isSuccess ? 'success' : 'error';
                resultElement.style.display = 'block';
            } else {
                console.log("结果:", message);
            }
        }
        
        // 计算函数
        function calculate() {
            try {
                const molecularWeightInput = document.getElementById('molecularWeight');
                const concentrationInput = document.getElementById('concentration');
                
                if (!molecularWeightInput || !concentrationInput) {
                    showResult("找不到必要的输入字段", false);
                    return;
                }
                
                const molecularWeight = parseFloat(molecularWeightInput.value);
                const concentration = parseFloat(concentrationInput.value);
                
                if (isNaN(molecularWeight) || molecularWeight <= 0) {
                    showResult("请输入有效的分子量", false);
                    return;
                }
                
                if (isNaN(concentration) || concentration <= 0) {
                    showResult("请输入有效的浓度", false);
                    return;
                }
                
                // 转换浓度单位到 mol/L
                const concentrationUnitSelect = document.getElementById('concentrationUnit');
                if (!concentrationUnitSelect) {
                    showResult("找不到浓度单位选择框", false);
                    return;
                }
                
                const concentrationUnit = concentrationUnitSelect.value;
                let concentrationMol;
                
                if (concentrationUnit === "mmol/L") {
                    concentrationMol = concentration / 1000;
                } else if (concentrationUnit === "mol/L") {
                    concentrationMol = concentration;
                } else {
                    // g/L转换为mol/L
                    concentrationMol = concentration / molecularWeight;
                }
                
                const massInput = document.getElementById('mass');
                const volumeInput = document.getElementById('volume');
                
                if (!massInput || !volumeInput) {
                    showResult("找不到质量或体积输入字段", false);
                    return;
                }
                
                const massInputValue = massInput.value.trim();
                const volumeInputValue = volumeInput.value.trim();
                
                if (massInputValue && !volumeInputValue) {
                    // 已知质量，计算体积
                    let mass = parseFloat(massInputValue);
                    if (isNaN(mass) || mass <= 0) {
                        showResult("请输入有效的质量", false);
                        return;
                    }
                    
                    // 根据质量单位转换
                    const massUnitSelect = document.getElementById('massUnit');
                    if (!massUnitSelect) {
                        showResult("找不到质量单位选择框", false);
                        return;
                    }
                    
                    const massUnit = massUnitSelect.value;
                    if (massUnit === "mg") {
                        mass = mass / 1000; // mg to g
                    }
                    
                    const volume = mass / (concentrationMol * molecularWeight);
                    let volumeMl = volume * 1000; // 转换为 mL
                    
                    const volumeUnitSelect = document.getElementById('volumeUnit');
                    if (!volumeUnitSelect) {
                        showResult("找不到体积单位选择框", false);
                        return;
                    }
                    
                    const volumeUnit = volumeUnitSelect.value;
                    if (volumeUnit === "L") {
                        volumeMl /= 1000;
                    }
                    
                    volumeInput.value = volumeMl.toFixed(2);
                    showResult(`计算的体积: ${volumeMl.toFixed(2)} ${volumeUnit}`);
                    
                } else if (volumeInputValue && !massInputValue) {
                    // 已知体积，计算质量
                    let volumeMl = parseFloat(volumeInputValue);
                    if (isNaN(volumeMl) || volumeMl <= 0) {
                        showResult("请输入有效的体积", false);
                        return;
                    }
                    
                    const volumeUnitSelect = document.getElementById('volumeUnit');
                    if (!volumeUnitSelect) {
                        showResult("找不到体积单位选择框", false);
                        return;
                    }
                    
                    const volumeUnit = volumeUnitSelect.value;
                    if (volumeUnit === "L") {
                        volumeMl *= 1000; // L to mL
                    }
                    
                    const volume = volumeMl / 1000; // mL to L
                    let mass = concentrationMol * molecularWeight * volume;
                    
                    const massUnitSelect = document.getElementById('massUnit');
                    if (!massUnitSelect) {
                        showResult("找不到质量单位选择框", false);
                        return;
                    }
                    
                    const massUnit = massUnitSelect.value;
                    if (massUnit === "mg") {
                        mass *= 1000; // g to mg
                    }
                    
                    massInput.value = mass.toFixed(4);
                    showResult(`计算的质量: ${mass.toFixed(4)} ${massUnit}`);
                    
                } else if (massInputValue && volumeInputValue) {
                    showResult("请只填写质量或体积中的一个", false);
                } else {
                    showResult("请填写质量或体积中的一个", false);
                }
                
            } catch (error) {
                showResult("计算出错: " + error.message, false);
            }
        }

        // 检测页面主题变化并相应更新
        function detectTheme() {
            // 检查是否处于暗模式
            const isDarkMode = document.documentElement.classList.contains('dark') || 
                               document.body.classList.contains('dark') ||
                               window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            // 应用相应的类
            if(isDarkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        }

        // 初始检测主题
        detectTheme();
        
        // 监听系统主题变化
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', detectTheme);
        
        // 监听Chirpy主题变化
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'class' || 
                    mutation.attributeName === 'data-mode') {
                    detectTheme();
                }
            });
        });
        
        // 观察文档根元素和body的类变化
        observer.observe(document.documentElement, { attributes: true });
        observer.observe(document.body, { attributes: true });
    </script>
</body>
