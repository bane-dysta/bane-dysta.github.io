---
title: ä¸ä½¿ç”¨sshè¿æ¥åˆ°æœåŠ¡å™¨è¿›è¡Œç§‘å­¦è®¡ç®—çš„å·¥ä½œæµè®¾è®¡
date: 2025-4-25 12:00:00 +0800
categories: [software]
tags: [software]   
---

ç»„é‡Œæ–°æœåŠ¡å™¨çš„ç¯å¢ƒè·Ÿç¬”è€…ä¹‹å‰ç™½å«–çš„å·®åˆ«å¤ªå¤§äº†ï¼Œä¸€æ—¶é—´æœ‰ç‚¹ä¸é€‚åº”ã€‚å¦‚æœå®Œå…¨å¤åˆ»ä»¥å‰çš„è®¡ç®—æ¨¡å¼æ˜¾å¾—å¤ªè ¢ï¼Œæ‰€ä»¥ç¬”è€…æ‰“ç®—åˆ©ç”¨æ‰‹å¤´çš„ä¸€äº›ç»„ä»¶ï¼Œæä¸€ä¸ªçº¯windowså®Œæˆè®¡ç®—çš„å·¥ä½œæµå‡ºæ¥ã€‚

ä¸»è¦è®°å½•inotifyéƒ¨åˆ†ï¼Œå…¶ä»–éƒ¨åˆ†éƒ½æ˜¯é•¿ä¹…ç§¯ç´¯å‡ºæ¥çš„å°å·¥å…·ğŸ˜¸

## æ–‡ä»¶äº¤æµ
è¿™é‡Œæ˜¾ç„¶è¦ç”¨[SMBæœåŠ¡](https://bane-dysta.top/posts/32/)ï¼ŒæŠŠè®¡ç®—ç›®å½•å½“æœ¬åœ°æ–‡ä»¶ä¸€æ ·æ“ä½œï¼Œéå¸¸èˆ’æœï¼Œå”¯ä¸€çš„ç¼ºç‚¹æ˜¯ä¸èƒ½ç”¨wslé‡Œçš„linuxç¨‹åºåšåå¤„ç†ã€‚

## ç§‘å­¦è®¡ç®—

### æäº¤è®¡ç®—ä»»åŠ¡
ç¬”è€…ç»™taskerå¥—ä»¶å†™è¿‡ä¸€ä¸ªæ‰«æç›®å½•é‡Œçš„è¾“å…¥å¹¶è‡ªåŠ¨æäº¤çš„è„šæœ¬`slurms.sh`ï¼Œé™„åœ¨taskeré‡Œäº†ã€‚ç”±äºç›®å‰æœåŠ¡å™¨ä¸Šè£…çš„æ˜¯sgeä»»åŠ¡ç³»ç»Ÿï¼Œè¦åšä¸€äº›ä¿®æ”¹ã€‚ä¿®æ”¹ç•¥ã€‚

### è§¦å‘è®¡ç®—
inotifywaitå¯ä»¥ç›‘è§†ç›®å½•ä¸‹çš„æ–‡ä»¶å˜åŒ–ï¼Œæˆ‘ä»¬å°±ä½¿ç”¨è¿™ä¸ªè½¯ä»¶ç›‘è§†ç‰¹å®šçš„æ–‡ä»¶åˆ›å»ºï¼Œæ¥è§¦å‘è®¡ç®—ï¼š
```bash
sudo dnf install inotify-tools
```
å†™ä¸€ä¸ªè„šæœ¬ï¼Œç›‘è§†è®¡ç®—ç›®å½•ï¼š
```
#!/bin/bash

# è®¾ç½®è¦ç›‘è§†çš„ç›®å½•
WATCH_DIR="{SMBå…±äº«å‡ºå»çš„ç›®å½•}"

# è®¾ç½®è§¦å‘æ–‡ä»¶å
TRIGGER_FILE="trigger.txt"

# è®¾ç½®è¦æ‰§è¡Œçš„è„šæœ¬è·¯å¾„
TARGET_SCRIPT="{è„šæœ¬ç›®å½•}"

# åˆ›å»ºæ—¥å¿—æ–‡ä»¶
LOG_FILE="/var/log/share_monitor.log"

echo "$(date): å¼€å§‹ç›‘è§†å…±äº«æ–‡ä»¶å¤¹ $WATCH_DIR" >> $LOG_FILE

# ä½¿ç”¨inotifywaitç›‘æ§æ–‡ä»¶å˜åŒ–
inotifywait -m -e create --format "%f" "$WATCH_DIR" | while read FILE
do
    if [ "$FILE" = "$TRIGGER_FILE" ]; then
        echo "$(date): æ£€æµ‹åˆ°è§¦å‘æ–‡ä»¶ï¼Œæ‰§è¡Œè„šæœ¬" >> $LOG_FILE
        
        # æ‰§è¡Œç›®æ ‡è„šæœ¬
        bash "$TARGET_SCRIPT"
        
        # åˆ é™¤è§¦å‘æ–‡ä»¶(å¯é€‰)
        rm "$WATCH_DIR/$TRIGGER_FILE"
        
        echo "$(date): è„šæœ¬æ‰§è¡Œå®Œæ¯•ï¼Œå·²åˆ é™¤è§¦å‘æ–‡ä»¶" >> $LOG_FILE
    fi
done
```
è¿™æ ·ï¼Œå½“trigger.txtç”Ÿæˆæ—¶ï¼Œinotifywaitå°±ä¼šè®©è¯¥è„šæœ¬æ‰§è¡Œé¢„å®šçš„ç¨‹åºã€‚ç¬”è€…è¿™é‡Œç”¨çš„å°±æ˜¯å‰è¿°`slurms.sh`ï¼Œæ‰«æè®¡ç®—ç›®å½•ï¼Œå¹¶æŠŠä»»åŠ¡äº¤åˆ°ä½œä¸šè°ƒåº¦ç³»ç»Ÿé‡Œã€‚

ä¸ºäº†æŒç»­ç›‘æ§ï¼Œåˆ›å»ºä¸€ä¸ªsystemdæœåŠ¡ï¼š
```bash
sudo vi /etc/systemd/system/share-monitor.service
```
ç¼–è¾‘ä»¥ä¸‹å†…å®¹ï¼š
```conf
[Unit]
Description=Monitor Shared Folder Service
After=network.target smb.service

[Service]
Type=simple
ExecStart={script}
Restart=always
User={user}
Group={user}

[Install]
WantedBy=multi-user.target
```
å…¶ä¸­ï¼š
- {script}æ˜¯åˆšåˆšçš„inotifyç›‘æ§è„šæœ¬
- {user}æ˜¯ä½ çš„ç”¨æˆ·å

è¿˜å¯ä»¥æ”¾ä¸€ä¸ªæ‰¹å¤„ç†è„šæœ¬è§¦å‘è®¡ç®—ï¼š
```bat
@echo off
echo Go to work you lazy system! > Z:\trigger.txt
```

### è‡ªåŠ¨åå¤„ç†
è¿™ä¸ªæµç¨‹æ—¢ç„¶ç”¨åˆ°äº†`slurms.sh`ï¼Œé‚£å°±é¡ºç†æˆç« åœ°å¯ä»¥ä½¿ç”¨taskerï¼Œç”¨taskfileè§„å®šåå¤„ç†é€»è¾‘ã€‚

